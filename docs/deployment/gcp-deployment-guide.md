# GCP 云端部署完整指南

**平台:** Google Cloud Platform (GCP)
**成本策略:** 免费层 + 按量计费 (API)
**推荐配置:** 开发/测试用免费层，生产用小规模付费

---

## 🎯 为什么选择 GCP

### vs AWS
- ✅ 免费额度更慷慨 (300 美元 + 永久免费服务)
- ✅ 数据库免费配额更高
- ✅ 简化的服务，少学习曲线
- ✅ 定价更透明

### vs 腾讯云
- ✅ 国际覆盖，API 调用延迟低
- ✅ 免费额度充分
- ✅ 支持按分钟计费
- ✅ 更灵活的扩展

---

## 📊 GCP 免费层额度 (永久)

| 服务 | 免费额度 | 说明 |
|------|---------|------|
| **Firestore** | 1GB 存储 | NoSQL 数据库 |
| **Cloud SQL** | 1 个实例 (0.6 vCPU, 3.75GB) | PostgreSQL/MySQL |
| **Cloud Storage** | 1GB/月 | 对象存储 |
| **Cloud Functions** | 200万次/月 + 400,000 GB-s | 无服务器计算 |
| **Pub/Sub** | 100GB/月 | 消息队列 |
| **Cloud Logging** | 50GB/月 | 日志存储 |
| **Cloud Memorystore** | 1GB (开发版) | Redis 缓存 |
| **App Engine** | 28 小时/天 | Web 应用托管 |
| **Secret Manager** | 无限密钥 | API 密钥管理 |

**总估值:** ~$10,000/年 的免费服务

---

## 🏗️ GCP 完整架构

```
┌────────────────────────────────────────────────────────┐
│              谷歌云平台 (GCP)                           │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌──────────────────────────────────────────────┐    │
│  │         外部数据源                            │    │
│  │  ┌────────┐  ┌────────┐  ┌────────┐         │    │
│  │  │ RSS源  │  │ API源  │  │ 网页源 │         │    │
│  │  │ (15)   │  │(可选)  │  │(可选)  │         │    │
│  │  └────────┘  └────────┘  └────────┘         │    │
│  └──────────┬───────────────────────────────────┘    │
│             │                                         │
│  ┌──────────▼──────────┐                             │
│  │  Cloud Functions    │                             │
│  │  (无服务器计算)      │                             │
│  │                     │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │collection_fn()  │ │ 采集函数 (08:00)           │
│  │ └────────┬────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │scoring_fn()     │ │ 评分函数 (09:00)           │
│  │ └────────┬────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │review_fn()      │ │ 审核函数 (14:00)           │
│  │ └────────┬────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │publish_fn()     │ │ 发布函数 (18:00)           │
│  │ └────────┬────────┘ │                             │
│  └─────────────────────┘                             │
│             │                                         │
│  ┌──────────▼──────────────────────┐                 │
│  │      数据层 (Data Layer)         │                 │
│  │                                  │                 │
│  │  ┌──────────────────────────┐   │                 │
│  │  │   Cloud SQL (PostgreSQL)  │   │ 主数据库        │
│  │  │   (永久免费配置)          │   │ 自动备份        │
│  │  └──────────────────────────┘   │                 │
│  │  ┌──────────────────────────┐   │                 │
│  │  │   Firestore (Firebase)    │   │ 文档存储 (备份) │
│  │  │   (免费 1GB)              │   │ 易于查询        │
│  │  └──────────────────────────┘   │                 │
│  │  ┌──────────────────────────┐   │                 │
│  │  │   Cloud Storage (GCS)     │   │ 对象存储 (备份) │
│  │  │   (免费 1GB/月)           │   │ 成本极低        │
│  │  └──────────────────────────┘   │                 │
│  └────────────────────────────────┘                  │
│             │                                         │
│  ┌──────────▼──────────┐                             │
│  │   消息和缓存层       │                             │
│  │                     │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ Pub/Sub         │ │ 消息队列                    │
│  │ │ (100GB/月免费)  │ │ 异步处理                    │
│  │ └─────────────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ Memorystore     │ │ Redis 缓存                  │
│  │ │ Redis (1GB)     │ │ 采集去重                    │
│  │ └─────────────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ Secret Manager  │ │ API 密钥管理                │
│  │ │ (无限密钥免费)  │ │ 安全存储                    │
│  │ └─────────────────┘ │                             │
│  └─────────────────────┘                             │
│             │                                         │
│  ┌──────────▼──────────┐                             │
│  │   监控和日志        │                             │
│  │                     │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ Cloud Logging   │ │ 日志聚合 (50GB/月)         │
│  │ └─────────────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ Cloud Monitoring│ │ 性能监控                    │
│  │ └─────────────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ Cloud Trace     │ │ 分布式追踪                  │
│  │ └─────────────────┘ │                             │
│  └─────────────────────┘                             │
│             │                                         │
│  ┌──────────▼──────────┐                             │
│  │   输出和集成        │                             │
│  │                     │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ WeChat 官方账号 │ │ 微信发布                    │
│  │ └─────────────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ 小红书 API      │ │ 小红书发布                  │
│  │ └─────────────────┘ │                             │
│  │ ┌─────────────────┐ │                             │
│  │ │ WordPress       │ │ Website                     │
│  │ └─────────────────┘ │                             │
│  └─────────────────────┘                             │
│                                                        │
└────────────────────────────────────────────────────────┘
```

---

## ⏰ 自闭环工作流

### 触发器配置

```yaml
# Cloud Scheduler 定时触发

采集任务:
  schedule: "0 8 * * *"  # 每天上午 8 点
  action: 调用 collection_fn

评分任务:
  trigger: Pub/Sub 消息 (采集完成)
  action: 并发调用 scoring_fn (5-10)

审核任务:
  schedule: "0 14 * * *"  # 每天下午 2 点
  action: 调用 review_fn (人工审核)

发布任务:
  schedule: "0 18 * * *"  # 每天下午 6 点
  action: 调用 publish_fn
```

---

## 💰 成本预估

### 场景 A: 初期 (仅使用免费层)

月度成本:
- Cloud SQL: ¥0 (免费)
- Cloud Storage: ¥0 (1GB/月免费)
- Cloud Functions: ¥0 (200万次免费)
- Memorystore: ¥0 (1GB免费)
- Pub/Sub: ¥0 (100GB/月免费)
- Cloud Logging: ¥0 (50GB/月免费)
- OpenAI API: ¥40-100
- **总计: ¥40-100/月**

### 场景 B: 生产 (轻量级)

月度成本:
- Cloud SQL HA: ¥500
- Memorystore: ¥100
- Cloud Functions: ¥5 (超额)
- Cloud CDN: ¥100
- OpenAI API: ¥150
- **总计: ¥855/月**

---

## 🔐 密钥管理 (Secret Manager)

GCP 使用 Secret Manager 管理所有 API 密钥：

```python
from google.cloud import secretmanager

def access_secret_version(secret_id, version_id="latest"):
    client = secretmanager.SecretManagerServiceClient()
    project_id = os.getenv("GCP_PROJECT_ID")
    name = f"projects/{project_id}/secrets/{secret_id}/versions/{version_id}"
    response = client.access_secret_version(request={"name": name})
    return response.payload.data.decode("UTF-8")

# 使用示例
openai_api_key = access_secret_version("openai-api-key")
```

### 密钥列表

```yaml
存储的密钥:
  - openai-api-key: OpenAI GPT-4o API
  - wechat-app-id: 微信应用ID
  - wechat-app-secret: 微信应用密钥
  - db-password: Cloud SQL 数据库密码
  - redis-password: Memorystore Redis 密码
  - webhook-secret: 外部 webhook 验证
```

---

## 🚀 部署检查清单

### 部署前
- [ ] GCP 项目创建
- [ ] 启用必要的 API
- [ ] 创建 VPC 和子网
- [ ] 配置服务账户权限
- [ ] 设置 Cloud SQL 实例
- [ ] 配置 Secret Manager 密钥

### 部署中
- [ ] 数据库迁移完成
- [ ] Cloud Functions 代码上传
- [ ] Cloud Scheduler 规则配置
- [ ] Pub/Sub 主题和订阅创建
- [ ] 环境变量配置
- [ ] 密钥管理配置

### 部署后
- [ ] 功能测试: 采集、评分、审核、发布
- [ ] 性能测试: 响应时间、并发处理
- [ ] 安全审计: IAM 权限、网络隔离
- [ ] 监控告警: 日志、指标、错误

---

**下一步:**
1. 完成本地功能 (采集、评分、审核、发布)
2. 准备 GCP 部署代码
3. 创建云函数包
4. 配置自动化工作流

