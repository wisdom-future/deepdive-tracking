# DeepDive Tracking - 架构图详解

**版本：** 1.0
**日期：** 2025-11-02

---

## 1. 系统总体架构图

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           外部数据源 (External Sources)                   │
│  RSS源 │ 爬虫 │ Twitter/X │ arXiv/GitHub API │ 官网API │ 邮件 │ 其他    │
└──────────────────────────────────────────────────────────────────────────┘
                                    ↓ (采集)
┌──────────────────────────────────────────────────────────────────────────┐
│                    数据采集引擎 (Data Collection Layer)                    │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ RSS爬虫 │ Scrapy爬虫 │ API客户端 │ Twitter监听 │ 邮件监听          │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                              ↓                                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 数据清洗与去重 (数据格式化 + Simhash去重 + 规范化)                  │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                              ↓                                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 队列系统 (RabbitMQ/Celery) ← 原始新闻入库                           │  │
│  │ raw_news_queue → processing_queue                                  │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                         ↓ (300-500条/天)
┌──────────────────────────────────────────────────────────────────────────┐
│                      AI处理引擎 (AI Processing Layer)                      │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │         任务分配器 (Intelligent Task Router)                       │  │
│  │  ├─ 评分 → OpenAI GPT-4o mini (低成本)                             │  │
│  │  ├─ 分类 → OpenAI GPT-4o mini (低成本)                             │  │
│  │  ├─ 专业摘要 → Claude 3.5 Sonnet (高质量)                          │  │
│  │  ├─ 科普摘要 → OpenAI GPT-4o (平衡)                                │  │
│  │  └─ 关键词 → Claude 3.5 Haiku (超低成本)                          │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                              ↓                                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ Redis缓存 (避免重复调用) + 成本追踪 + 质量评分                      │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                              ↓ (score≥70)                                │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 处理结果入库 (processed_news)                                       │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                         ↓ (约100条/天)
┌──────────────────────────────────────────────────────────────────────────┐
│                   内容管理系统 (Content Management Layer)                 │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 审核队列 (Review Queue) - 人工审核                                  │  │
│  │ ├─ ✅ 通过 → 编辑优化 → 待发布                                      │  │
│  │ ├─ 📝 修改 → 编辑器 → 重新审核                                      │  │
│  │ └─ ❌ 拒绝 → 记录原因 → 学习改进                                    │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                              ↓ (约30条/天)                               │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 编辑优化 (Editorial Refinement)                                     │  │
│  │ ├─ 修改摘要/标题 (保证准确性)                                       │  │
│  │ ├─ 调整标签/分类 (改进相关性)                                       │  │
│  │ ├─ 排版预览 (确保格式)                                              │  │
│  │ └─ 生成图片/引用 (增强表现)                                         │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                         ↓ (约5-10条/天)
┌──────────────────────────────────────────────────────────────────────────┐
│                  发布分发系统 (Publishing Distribution Layer)             │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐          │
│  │ 微信公众号    │  小红书      │   Web平台    │  邮件推送    │          │
│  │ (每日9点)    │ (每日18点)   │  (实时)      │  (定制)      │          │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤          │
│  │ • 快讯       │ • 图文卡片   │ • 时间线     │ • 日摘要     │          │
│  │ • 周报       │ • 知识系列   │ • 分类筛选   │ • 周报       │          │
│  │ • 深度文章   │              │ • 搜索功能   │              │          │
│  └──────────────┴──────────────┴──────────────┴──────────────┘          │
│                              ↓                                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 用户交互追踪 (User Interaction Tracking)                            │  │
│  │ ├─ 阅读量、点赞、分享、评论                                        │  │
│  │ ├─ 完成率、停留时长                                               │  │
│  │ ├─ NPS反馈收集                                                    │  │
│  │ └─ 内容优化学习                                                   │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                   数据存储层 (Data Storage Layer)                         │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐          │
│  │ PostgreSQL   │    Redis     │ Elasticsearch│   S3/OSS     │          │
│  │ (关系数据)   │  (缓存/队列) │  (全文搜索)  │  (对象存储)  │          │
│  └──────────────┴──────────────┴──────────────┴──────────────┘          │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                  后台管理系统 (Admin Management System)                    │
│  ┌───────────┬───────────┬───────────┬───────────┬───────────┐         │
│  │ Dashboard │ 源管理    │ 审核管理  │ Prompt    │ 数据分析  │         │
│  │ (概览)    │ (增删改查)│ (队列)    │ (管理)    │ (报表)    │         │
│  └───────────┴───────────┴───────────┴───────────┴───────────┘         │
│                                ↑                                        │
│  认证 & 授权 (JWT + 角色权限)                                            │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据处理流程图

```
时间线视图：

T+0分钟:    采集起始
     │
     ├→ RSS爬虫 (10-20条/源)
     ├→ 网页爬虫 (5-10条/源)
     ├→ API查询 (20-30条/源)
     ├→ Twitter监听 (5条/账号)
     └→ 邮件监听 (1-2条)
     │
     ▼
     [数据清洗 + 去重 + 入库]
     │
     ▼
T+1-5分钟: AI处理（并行处理）
     │
     ├→ 评分模块 (0-100分)
     ├→ 分类模块 (8个类别)
     ├→ 关键词提取 (3-5个)
     ├→ 专业摘要生成
     ├→ 科普摘要生成
     └→ 技术术语对照
     │
     ▼
T+5-20分钟: 内容审核
     │
     ├→ 高分内容 (score≥70) 进入审核队列
     ├→ 人工审核 (30-50条)
     │  ├─ ✅ 通过 (70%)
     │  ├─ 📝 修改 (20%)
     │  └─ ❌ 拒绝 (10%)
     │
     ▼
T+20-60分钟: 编辑优化
     │
     ├→ 修改摘要/标题
     ├→ 调整标签/分类
     ├→ 排版预览
     └→ 最终审核
     │
     ▼
T+8:45 (下一天早上):
     │
     ├→ [生成每日快讯]
     │  ├─ 1条深度（头条）
     │  ├─ 5条精简（Top 5）
     │  └─ 5-8条速览
     │
     ├→ [模板适配]
     │  ├─ 微信格式
     │  ├─ 小红书格式
     │  └─ Web格式
     │
     ├→ [定时发布]
     │  ├─ 微信API (9:00)
     │  ├─ 小红书API (18:00)
     │  └─ Web实时
     │
     ▼
T+9:00 (用户接收):
     │
     └→ [用户交互追踪]
        ├─ 阅读量
        ├─ 点赞率
        ├─ 分享率
        └─ 完成率
```

---

## 3. 数据库关系图

```
概念模型：

       数据源                    原始新闻                处理结果
    ┌──────────┐             ┌──────────┐           ┌──────────┐
    │data_     │ 1        N  │raw_news  │ 1      1  │processed │
    │sources   │─────────────│          │───────────│_news     │
    └──────────┘             └──────────┘           └──────────┘
                                                           │
                                                       1   │
                                                   ┌───────┘
                                                   │
                                          ┌────────▼──┐
                                          │content_   │
                                          │review     │
                                          └────────┬──┘
                                                   │
                                               1   │
                                           ┌───────┘
                                           │
                                      ┌────▼─────────┐
                                      │published_    │
                                      │content       │
                                      └────┬─────────┘
                                           │
                                        N  │  1
                                   ┌───────┘
                                   │
                            ┌──────▼───────┐
                            │content_stats │
                            └──────────────┘


发布任务管理：

    ┌──────────────────┐
    │publishing_       │
    │schedules         │
    │                  │
    │ content_ids: []  │
    │ scheduled_at     │
    │ status           │
    │ result (JSONB)   │
    └──────┬───────────┘
           │
           │ 包含多个 content_id
           │
           ├→ 微信发布 → wechat_msg_id
           ├→ 小红书发布 → xiaohongshu_post_id
           └→ Web发布 → web_url


成本追踪：

    ┌─────────────────┐
    │cost_logs        │
    │                 │
    │ service         │ ◄─── "openai", "claude", "wechat"
    │ operation       │ ◄─── "scoring", "summarization"
    │ usage_units     │ ◄─── tokens数量
    │ unit_price      │ ◄─── 单价
    │ total_cost      │ ◄─── 总成本
    └─────────────────┘
```

---

## 4. AI处理引擎详细流程

```
输入：raw_news (标题 + 摘要 + 内容)

                        ┌─────────────────────┐
                        │ 任务分配器           │
                        │ Task Router         │
                        └──────────┬──────────┘
                                   │
                 ┌─────────────────┼─────────────────┐
                 │                 │                 │
                 ▼                 ▼                 ▼
        ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │ 评分任务      │  │ 分类任务      │  │ 关键词任务    │
        │ Scoring      │  │ Classify     │  │ Keywords     │
        │              │  │              │  │              │
        │ Model:       │  │ Model:       │  │ Model:       │
        │ GPT-4o mini  │  │ GPT-4o mini  │  │ Claude Haiku │
        │              │  │              │  │              │
        │ Cost: $0.05  │  │ Cost: $0.03  │  │ Cost: $0.02  │
        │ Time: 30s    │  │ Time: 20s    │  │ Time: 15s    │
        └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
               │                 │                 │
               ▼                 ▼                 ▼
        ┌──────────────────────────────────────────┐
        │ 缓存检查 (Redis)                         │
        │ 如果已处理过相同内容，返回缓存结果        │
        └──────────────────────────────────────────┘
               │
               ▼
        ┌──────────────────────────────────────────┐
        │ 摘要生成任务（并行处理）                 │
        └──────────┬───────────────────────────────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
  ┌───────────────┐    ┌──────────────┐
  │ 专业版摘要     │    │ 科普版摘要    │
  │ Pro Summary   │    │ Sci Summary  │
  │               │    │              │
  │ Model:        │    │ Model:       │
  │ Claude Sonnet │    │ GPT-4o       │
  │               │    │              │
  │ Cost: $0.15   │    │ Cost: $0.10  │
  │ Time: 45s     │    │ Time: 45s    │
  └───────┬───────┘    └──────┬───────┘
          │                   │
          └───────────┬───────┘
                      │
                      ▼
          ┌──────────────────────────┐
          │ 结果聚合与验证           │
          │ - 评分有效性检查         │
          │ - 分类一致性检查         │
          │ - 摘要质量检查           │
          └──────────┬───────────────┘
                     │
                     ▼
          ┌──────────────────────────┐
          │ 技术术语提取             │
          │ - 识别关键技术术语        │
          │ - 中英文对照             │
          │ - 解释说明               │
          └──────────┬───────────────┘
                     │
                     ▼
          ┌──────────────────────────┐
          │ 成本与质量记录           │
          │ - cost_logs 入库         │
          │ - quality_score 计算     │
          │ - 性能监控               │
          └──────────┬───────────────┘
                     │
                     ▼
          ┌──────────────────────────┐
          │ 输出：processed_news     │
          │ ✓ score (0-100)          │
          │ ✓ category (8类)         │
          │ ✓ summary_pro            │
          │ ✓ summary_sci            │
          │ ✓ keywords               │
          │ ✓ tech_terms (JSONB)     │
          └──────────────────────────┘
```

---

## 5. 发布流程图

```
审核通过的内容
     │
     ▼
┌─────────────────────────────┐
│ published_content 表 (draft) │
│ - id: 123                   │
│ - status: draft             │
│ - channels: [wechat, ...]   │
└──────────┬──────────────────┘
           │
           ▼
   ┌──────────────────────┐
   │ 定时任务触发         │
   │ (Celery Beat)        │
   │                      │
   │ 每日 8:45 → 9:00     │
   │ 每日 17:45 → 18:00   │
   │ 周日 19:45 → 20:00   │
   └──────────┬───────────┘
              │
              ▼
   ┌──────────────────────────────┐
   │ 内容适配与模板填充           │
   │                              │
   │ 微信版本:                    │
   │ ├─ Markdown格式              │
   │ ├─ 原文链接                  │
   │ └─ 二维码                    │
   │                              │
   │ 小红书版本:                  │
   │ ├─ 图文格式 (3-5图)          │
   │ ├─ 话题标签 (#AI #技术)      │
   │ └─ 评论区补充                │
   └──────────┬──────────────────┘
              │
              ▼
   ┌──────────────────────────────┐
   │ 发布执行                     │
   │                              │
   │ ┌────────────────────────┐   │
   │ │ 微信公众号API          │   │
   │ │ POST /message/mass/send│   │
   │ │ Response: msg_id       │   │
   │ └────────────────────────┘   │
   │                              │
   │ ┌────────────────────────┐   │
   │ │ 小红书API              │   │
   │ │ POST /v2/post/publish  │   │
   │ │ Response: post_id      │   │
   │ └────────────────────────┘   │
   │                              │
   │ ┌────────────────────────┐   │
   │ │ Web平台                │   │
   │ │ INSERT published_content│  │
   │ │ 实时显示                │   │
   │ └────────────────────────┘   │
   └──────────┬──────────────────┘
              │
              ▼
   ┌──────────────────────────────┐
   │ 发布结果处理                 │
   │                              │
   │ ✓ 成功:                      │
   │   - published_content.status │
   │   - published_at             │
   │   - channel_url              │
   │   - cost_logs.记录           │
   │                              │
   │ ✗ 失败:                      │
   │   - 重试 (指数退避)           │
   │   - error_message 记录       │
   │   - 告警通知                 │
   └──────────┬──────────────────┘
              │
              ▼
   ┌──────────────────────────────┐
   │ 用户交互追踪启动             │
   │                              │
   │ 微信: message stats          │
   │ 小红书: engagement metrics   │
   │ Web: pageview tracking       │
   │                              │
   │ → content_stats 表定时更新   │
   └──────────────────────────────┘
```

---

## 6. 系统部署架构

```
┌─────────────────────────────────────────────────────┐
│              Nginx (负载均衡 + 反向代理)             │
│              - HTTPS终止                           │
│              - 速率限制                             │
│              - 日志记录                             │
└────────────────────┬────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
    ┌────────┐  ┌────────┐  ┌────────┐
    │API     │  │API     │  │API     │
    │实例 1  │  │实例 2  │  │实例 3  │
    └────┬───┘  └────┬───┘  └────┬───┘
         │           │           │
         └───────────┼───────────┘
                     │
        ┌────────────┼────────────────┐
        │            │                │
        ▼            ▼                ▼
    ┌────────┐  ┌────────┐      ┌──────────┐
    │PostgreSQL  │Redis  │      │RabbitMQ  │
    │(主)   │  │(缓存) │      │(消息队列)│
    └───┬────┘  └────────┘      └──────────┘
        │
        ▼
    ┌────────┐
    │PostgreSQL│
    │(从)   │
    └────────┘

后台任务：
    ┌──────────────────────┐
    │ Celery Worker Pool   │
    │                      │
    │ 采集 (10个并发)     │
    │ AI处理 (20个并发)   │
    │ 发布 (5个并发)      │
    │ 分析 (2个并发)      │
    └──────────────────────┘

定时任务：
    ┌──────────────────────┐
    │ Celery Beat          │
    │                      │
    │ 每30分钟: 采集       │
    │ 每小时: 清理缓存     │
    │ 每天8:45: 快讯      │
    │ 每周日19:45: 周报   │
    └──────────────────────┘

监控告警：
    ┌──────────────────────┐
    │ ELK + Prometheus     │
    │ Grafana + AlertManager│
    │ 钉钉/企业微信机器人  │
    └──────────────────────┘
```

---

## 7. 缓存分层架构

```
                    用户请求
                         │
                         ▼
                    ┌─────────┐
                    │ Nginx   │
                    │ 缓存    │
                    └────┬────┘
                         │
                    命中/未命中
                    /            \
                   ✓             ✗
                  返回         继续
                              │
                              ▼
                        ┌──────────┐
                        │ Redis L1 │
                        │ (1小时)  │
                        │ - 内容   │
                        │ - 统计   │
                        └────┬─────┘
                             │
                        命中/未命中
                        /          \
                       ✓            ✗
                      返回        继续
                                  │
                                  ▼
                        ┌──────────────┐
                        │ Redis L2     │
                        │ (1天)        │
                        │ - 配置       │
                        │ - 健康状态   │
                        └────┬────────┘
                             │
                        命中/未命中
                        /          \
                       ✓            ✗
                      返回        继续
                                  │
                                  ▼
                        ┌──────────────┐
                        │ PostgreSQL   │
                        │ (终极存储)   │
                        └──────────────┘
```

---

## 8. 错误恢复与容错流程

```
外部API调用
     │
     ▼
┌──────────────┐
│ 发送请求     │
└──────┬───────┘
       │
       ▼
    成功?
   /     \
  ✓       ✗
返回    继续
  │       │
  │       ▼
  │   ┌──────────────────┐
  │   │ 记录失败         │
  │   │ retry_count++    │
  │   └────────┬─────────┘
  │            │
  │            ▼
  │        ┌──────────────────────┐
  │        │ retry_count > max?    │
  │        └─┬──────────────────┬─┘
  │          │                  │
  │       是 │                  │ 否
  │          ▼                  ▼
  │      ┌─────────┐      ┌──────────────┐
  │      │禁用源    │      │等待延迟      │
  │      │告警通知  │      │(指数退避)    │
  │      │转移备用  │      │1s→2s→4s→8s │
  │      └─────────┘      └──────┬───────┘
  │                              │
  │                              ▼
  │                         ┌──────────┐
  │                         │ 重新尝试 │
  │                         └──────────┘
  │                              │
  │                              └──→ (循环)
  │
  └────────→ 返回成功结果
```

---

## 9. 监控告警体系

```
系统健康度
├─ 资源层
│  ├─ CPU使用率 (目标 <70%)
│  ├─ 内存使用率 (目标 <80%)
│  ├─ 磁盘使用率 (目标 <80%)
│  └─ 网络带宽 (目标 <60%)
│
├─ 应用层
│  ├─ QPS
│  ├─ 响应时间 (p50, p95, p99)
│  ├─ 错误率 (目标 <0.1%)
│  ├─ 缓存命中率 (目标 >80%)
│  └─ 慢查询 (>1s)
│
├─ 业务层
│  ├─ 日采集量
│  ├─ 日处理量
│  ├─ 通过率 (score≥70)
│  ├─ 发布延迟
│  └─ 用户参与度
│
└─ 依赖服务
   ├─ OpenAI API 可用性
   ├─ Claude API 可用性
   ├─ 数据库连接
   ├─ Redis连接
   ├─ RabbitMQ队列
   └─ 各信息源可用性

           ↓

告警规则执行
├─ P1 (严重): 立即告警 + 自动回滚
├─ P2 (高): 立即告警 + 记录
└─ P3 (中): 定时汇总

           ↓

告警通知
├─ 钉钉机器人
├─ 企业微信
├─ 邮件
└─ SMS (可选)
```

---

**文档完成：** 2025-11-02
