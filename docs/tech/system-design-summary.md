# DeepDive Tracking - 系统设计总结（审核版）

**编制日期：** 2025-11-02
**设计者：** 架构团队
**审核状态：** 待审核

---

## 📋 文档清单

我已为您的 DeepDive Tracking 项目生成了完整的系统设计文档，包括：

### 技术架构文档
- ✅ **技术架构设计文档 v1.0** (`DeepDive-Tracking_Tech_Architecture_v1.0.md`)
  - 系统概览和规模预估
  - 分层架构设计
  - 数据采集、AI处理、内容管理、发布分发等核心模块
  - 数据流设计
  - 缓存策略、异步处理、可靠性设计
  - 扩展性、安全性、性能指标
  - 部署架构和监控告警

- ✅ **数据库设计文档** (`DeepDive-Tracking_Database_Schema.md`)
  - PostgreSQL数据库设计（9个核心表）
  - 详细的表结构、字段定义和约束
  - ER图和关系设计
  - 索引策略和优化建议
  - 数据生命周期说明
  - 备份和恢复方案

- ✅ **API设计文档 v1.0** (`DeepDive-Tracking_API_Design.md`)
  - RESTful API设计规范
  - 认证与授权（JWT、API Key、签名）
  - 核心API接口（内容查询、审核、信息源、发布等）
  - 后台管理API
  - 错误处理和错误码定义
  - 速率限制策略
  - API使用示例

---

## 🏗️ 架构设计核心特点

### 1. 分层架构设计

```
表现层    → API接口 / 后台Web界面
应用层    → 业务逻辑 / 工作流编排
服务层    → 数据采集 / AI处理 / 内容管理 / 发布
数据层    → PostgreSQL / Redis / 消息队列 / 对象存储
```

**优点：**
- 清晰的职责分离
- 易于维护和测试
- 支持团队协作

### 2. 数据流处理流程

```
T+0:      采集 → raw_news (300-500条)
T+0-5分钟: AI处理 → 评分、分类、摘要
T+5-20分钟: 人工审核 → content_review
T+20-60分钟: 编辑优化 → 最终内容
T+8:45/17:45/周日20:00: 定时发布 → 多渠道
```

**特点：**
- 完整的处理链路
- 每个环节可追踪
- 支持批量和实时处理

### 3. 高可靠性设计

| 可靠性机制 | 实现方式 |
|----------|--------|
| **冗余备份** | 多源信息源、数据库主从复制 |
| **重试机制** | 指数退避、最大重试次数 |
| **熔断器** | 连续失败自动禁用 |
| **降级策略** | Redis宕机时使用DB、API失败使用缓存 |
| **死信队列** | 失败任务重新处理 |

### 4. 成本优化设计（多供应商策略）

| 优化措施 | 效果 |
|--------|------|
| **多供应商AI智能路由** | Twitter/X→Grok(实时)，RSS→OpenAI(通用)，复杂→Claude(推理)，节省15-20% |
| **源类型感知优化** | Grok原生理解X语境，避免过度处理，降低成本 |
| **缓存策略** | 减少API调用30%以上 |
| **批量处理** | 提升效率，降低单位成本 |
| **成本实时监控** | 超预算自动降级，支持多供应商切换 |

**预估成本（多供应商策略）：¥1950-3200/月（节省¥350-600/月，约15-20%）**

**按来源的成本分布：**
```
OpenAI API:      ¥800-1500/月   (RSS、Web爬虫内容 - 通用评分)
Grok/xAI API:    ¥600-1200/月   (Twitter/X专用 - 实时趋势识别)
Claude API:      ¥400-600/月    (复杂分析、深度推理、备选方案)
基础设施:        ¥300-500/月    (服务器、数据库、缓存)
其他服务:        ¥500-700/月    (存储、DNS、监控)
─────────────────────────────
合计:            ¥2600-4500/月

使用多供应商策略后：¥1950-3200/月（相比单一OpenAI节省15-20%）
```

---

## 🗄️ 数据库设计亮点

### 核心表结构 (9张表)

| 表名 | 用途 | 关键字段 | 优先级 |
|------|------|--------|-------|
| `data_sources` | 信息源管理 | name, type, url, priority | P1 |
| `raw_news` | 原始新闻 | source_id, hash, status | P1 |
| `processed_news` | AI处理结果 | score, category, summary | P1 |
| `content_review` | 审核流程 | status, reviewed_by, edited_by | P1 |
| `published_content` | 已发布内容 | publish_status, channels | P1 |
| `content_stats` | 用户交互 | view_count, like_count, completion_rate | P2 |
| `publishing_schedules` | 定时发布 | schedule_type, status | P2 |
| `cost_logs` | 成本追踪 | service, cost | P3 |
| `operation_logs` | 操作审计 | operation_type, operator_id | P3 |

### 设计原则

1. **规范化设计** - 避免冗余，通过关联表管理
2. **性能优化** - 为常用查询建立复合索引
3. **可审计性** - 所有操作记录完整链路
4. **扩展性** - 支持时间分区、读写分离

---

## 🔌 API设计规范

### 三层API体系

```
公开API (Public)
  ├─ /api/v1/public/contents     # 内容查询
  ├─ /api/v1/public/analytics    # 数据统计
  └─ 无需认证或可选认证

管理API (Admin)
  ├─ /api/v1/admin/review        # 审核管理
  ├─ /api/v1/admin/sources       # 信息源管理
  ├─ /api/v1/admin/publish       # 发布管理
  └─ 需要JWT认证 + 角色权限

内部API (Internal)
  ├─ /api/v1/internal/...        # 系统内部通信
  └─ 需要签名认证
```

### 认证方式

| 认证方式 | 用途 | 安全性 |
|--------|------|-------|
| **JWT Token** | 后台管理用户 | ⭐⭐⭐⭐ |
| **API Key** | 内部服务 | ⭐⭐⭐⭐ |
| **HMAC签名** | 第三方集成 | ⭐⭐⭐⭐⭐ |

### 速率限制

- 未认证用户：100 req/hour per IP
- 已认证用户：1000 req/hour
- 管理员：5000 req/hour

---

## 📊 关键技术指标

### 系统SLA目标

| 指标 | 目标 | 说明 |
|------|------|------|
| 可用性 | >99.5% | 每月允许3.6小时宕机 |
| 采集延迟 | <5分钟 | 新闻采集速度 |
| 处理延迟 | <20分钟 | AI处理完成 |
| 发布延迟 | <1小时 | 审核到发布 |
| API响应时间 | <2s (p95) | 主要接口 |
| 缓存命中率 | >80% | 减少数据库压力 |

### 成本预算

```
OpenAI API:    ¥1000-2000/月  (评分、分类、摘要)
Claude API:    ¥500-800/月    (专业分析)
基础设施:      ¥300-500/月    (服务器、数据库)
其他服务:      ¥500-700/月    (存储、DNS、监控)
─────────────────────────
合计:         ¥2300-4000/月
```

---

## 🎯 实施建议

### Phase 1: MVP核心功能 (Month 1-2)

**必须完成：**
- [ ] 数据采集引擎（RSS + 基础爬虫）
- [ ] AI处理引擎（评分 + 分类 + 摘要生成）
- [ ] 内容审核系统（管理后台）
- [ ] 微信公众号发布集成
- [ ] PostgreSQL + Redis部署
- [ ] 基础监控告警

**可选：**
- [ ] Web版本管理后台 → 用Streamlit快速原型
- [ ] 完整的日志系统

### Phase 2: 完整MVP (Month 3-4)

**核心目标：**
- [ ] 小红书发布集成
- [ ] 发布历史和统计分析
- [ ] 成本监控和优化
- [ ] 性能优化和缓存优化
- [ ] 完善的错误处理和重试机制

**质量目标：**
- WAU: 500+
- 阅读完成率: >50%
- 系统可用性: >99%

### Phase 3: 扩展功能 (Month 5-6)

- [ ] Web平台（React版本）
- [ ] 个性化订阅
- [ ] 邮件推送
- [ ] 高级分析和报表
- [ ] A/B测试框架

---

## ⚠️ 关键风险和应对

### 内容风险

| 风险 | 影响 | 应对 |
|------|------|------|
| AI误判 | 推送不重要内容 | 人工审核 + 用户反馈闭环 |
| 信息滞后 | 采集不及时 | 多源备份，关键源人工监控 |
| 技术错误 | 发布错误信息 | 多源验证，专家审核 |
| 版权纠纷 | 法律风险 | 严格注明来源，自己改写 |

### 运营风险

| 风险 | 影响 | 应对 |
|------|------|------|
| API失效 | 无法生成内容 | 模型备用，缓存本地结果 |
| 平台违规 | 账号被禁 | 敏感词过滤，合规审查 |
| 成本失控 | 预算超支 | 实时监控，自动降级 |

---

## 📁 文件组织

```
docs/
├── 01-Product/
│   └── DeepDive-Tracking_PRD_Core_v1.0.md          (产品需求)
│
├── 02-Tech/                                         ← 系统设计文档
│   ├── DeepDive-Tracking_Tech_Architecture_v1.0.md ✅
│   ├── DeepDive-Tracking_Database_Schema.md         ✅
│   ├── DeepDive-Tracking_API_Design.md              ✅
│   └── DeepDive-Tracking_Deployment_Guide.md        (待编写)
│
├── 03-Content/
│   └── ... (内容相关文档)
│
├── 04-Operations/
│   └── ... (运营相关文档)
│
└── 05-Brand/
    └── ... (品牌相关文档)
```

---

## ✅ 审核清单

请您逐项审核以下内容：

### 架构层面
- [ ] 分层架构设计是否合理？
- [ ] 数据流处理是否完整？
- [ ] 可靠性设计是否充分？
- [ ] 扩展性是否满足需求？

### 数据层面
- [ ] 数据库表设计是否完整？
- [ ] 索引策略是否合理？
- [ ] 数据生命周期是否清晰？

### API层面
- [ ] API接口设计是否符合RESTful规范？
- [ ] 认证授权机制是否安全？
- [ ] 错误处理是否完善？

### 运维层面
- [ ] 监控告警是否充分？
- [ ] 备份恢复方案是否可行？
- [ ] 性能指标是否合理？

---

## 🔄 后续工作

### 立即需要做的：
1. **您的审核反馈** - 根据审核意见调整设计
2. **部署指南编写** - Docker/K8s部署脚本
3. **API实现** - FastAPI框架实现
4. **数据库初始化** - 创建表和索引脚本

### 可以并行进行的：
1. **前端开发** - 后台管理界面（Streamlit或React）
2. **爬虫开发** - 数据采集引擎
3. **测试用例** - 单元测试和集成测试

---

## 📞 需要确认的问题

1. **AI多供应商策略** - 是否同意采用多供应商路由？(OpenAI主，Grok/X专用，Claude深度分析)
   - Twitter/X内容 → Grok/xAI（原生理解X语境）
   - RSS/Web内容 → OpenAI GPT-4o mini（通用评分）
   - 复杂分析 → Claude（深度推理和备选）
   - **预期节省：** ¥350-600/月（15-20%成本优化）

2. **Grok集成时机** - Phase 4单独实施还是并入Phase 1？
   - 建议：Phase 4（3周工期）在MVP基础上实施，降低风险

3. **发布渠道优先级** - 先做微信还是小红书？

4. **存储方案** - 用阿里云OSS还是AWS S3？

5. **团队规模** - MVP阶段真实可投入的人员？

6. **时间表** - Month 1-2的确切开始和截止日期？

---

## 📖 如何使用这份设计文档

### 对于开发团队：
- 参考**技术架构**文档理解系统整体设计
- 参考**数据库设计**文档创建表和写SQL
- 参考**API设计**文档实现接口

### 对于测试团队：
- 基于**数据流**设计编写集成测试
- 基于**API**定义编写接口测试
- 基于**监控指标**编写性能测试

### 对于产品团队：
- 基于**API**规范验证功能实现
- 基于**数据库**设计验证数据准确性
- 基于**监控指标**跟踪产品KPI

---

## 总体评价

✅ **架构完整性：** 从数据采集到发布分发的完整闭环
✅ **技术可行性：** 采用成熟的技术栈和开源方案
✅ **扩展能力：** 支持水平扩展和功能扩展
✅ **成本控制：** 精细化的成本模型和优化方案
✅ **可靠性：** 多层次的容错和降级机制

**建议：** 建议按照 Phase 1 → Phase 2 → Phase 3 的顺序逐步实施，每个阶段都设置明确的KPI和验收标准。

---

**文档生成时间：** 2025-11-02
**文档版本：** 1.0
**状态：** 待审核
**下一步：** 请提供审核意见和反馈
